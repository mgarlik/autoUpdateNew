{"version":3,"sources":["../src/MacUpdater.ts"],"names":[],"mappings":"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","sourcesContent":["import { AllPublishOptions, newError, safeStringifyJson, UpdateInfo } from \"builder-util-runtime\"\nimport { createReadStream, stat } from \"fs-extra-p\"\nimport { createServer, IncomingMessage, ServerResponse } from \"http\"\nimport { AddressInfo } from \"net\"\nimport { AppUpdater, DownloadUpdateOptions } from \"./AppUpdater\"\nimport { UPDATE_DOWNLOADED } from \"./main\"\nimport { findFile } from \"./providers/Provider\"\nimport AutoUpdater = Electron.AutoUpdater\n\nexport class MacUpdater extends AppUpdater {\n  private readonly nativeUpdater: AutoUpdater = require(\"electron\").autoUpdater\n\n  private updateInfoForPendingUpdateDownloadedEvent: UpdateInfo | null = null\n\n  constructor(options?: AllPublishOptions) {\n    super(options)\n\n    this.nativeUpdater.on(\"error\", it => {\n      this._logger.warn(it)\n      this.emit(\"error\", it)\n    })\n    this.nativeUpdater.on(\"update-downloaded\", () => {\n      const updateInfo = this.updateInfoForPendingUpdateDownloadedEvent\n      this.updateInfoForPendingUpdateDownloadedEvent = null\n      this.emit(UPDATE_DOWNLOADED, updateInfo)\n    })\n  }\n\n  protected async doDownloadUpdate(downloadUpdateOptions: DownloadUpdateOptions): Promise<Array<string>> {\n    this.updateInfoForPendingUpdateDownloadedEvent = null\n\n    const files = (await this.provider).resolveFiles(downloadUpdateOptions.updateInfo)\n    const zipFileInfo = findFile(files, \"zip\", [\"pkg\", \"dmg\"])\n    if (zipFileInfo == null) {\n      throw newError(`ZIP file not provided: ${safeStringifyJson(files)}`, \"ERR_UPDATER_ZIP_FILE_NOT_FOUND\")\n    }\n\n    const server = createServer()\n    server.on(\"close\", () => {\n      this._logger.info(`Proxy server for native Squirrel.Mac is closed (was started to download ${zipFileInfo.url.href})`)\n    })\n\n    function getServerUrl() {\n      const address = server.address() as AddressInfo\n      return `http://${address.address}:${address.port}`\n    }\n\n    return await this.executeDownload({\n      fileExtension: \"zip\",\n      fileInfo: zipFileInfo,\n      downloadUpdateOptions,\n      task: (destinationFile, downloadOptions) => {\n        return this.httpExecutor.download(zipFileInfo.url.href, destinationFile, downloadOptions)\n      },\n      done: async updateFile => {\n        this.updateInfoForPendingUpdateDownloadedEvent = downloadUpdateOptions.updateInfo\n        let updateFileSize = zipFileInfo.info.size\n        if (updateFileSize == null) {\n          updateFileSize = (await stat(updateFile)).size\n        }\n\n        return await new Promise<Array<string>>((resolve, reject) => {\n          server.on(\"request\", (request: IncomingMessage, response: ServerResponse) => {\n            const requestUrl = request.url!!\n            this._logger.info(`${requestUrl} requested`)\n            if (requestUrl === \"/\") {\n              const data = Buffer.from(`{ \"url\": \"${getServerUrl()}/app.zip\" }`)\n              response.writeHead(200, {\"Content-Type\": \"application/json\", \"Content-Length\": data.length})\n              response.end(data)\n            }\n            else if (requestUrl.startsWith(\"/app.zip\")) {\n              let errorOccurred = false\n              response.on(\"finish\", () => {\n                try {\n                  setImmediate(() => server.close())\n                }\n                finally {\n                  if (!errorOccurred) {\n                    this.nativeUpdater.removeListener(\"error\", reject)\n                    resolve([])\n                  }\n                }\n              })\n\n              this._logger.info(`app.zip requested by Squirrel.Mac, pipe ${updateFile}`)\n\n              const readStream = createReadStream(updateFile)\n              readStream.on(\"error\", error => {\n                try {\n                  response.end()\n                }\n                catch (e) {\n                  errorOccurred = true\n                  this.nativeUpdater.removeListener(\"error\", reject)\n                  reject(new Error(`Cannot pipe \"${updateFile}\": ${error}`))\n                }\n              })\n\n              response.writeHead(200, {\n                \"Content-Type\": \"application/zip\",\n                \"Content-Length\": updateFileSize,\n              })\n              readStream.pipe(response)\n            }\n            else {\n              this._logger.warn(`${requestUrl} requested, but not supported`)\n              response.writeHead(404)\n              response.end()\n            }\n          })\n          server.listen(0, \"127.0.0.1\", 8, () => {\n            this.nativeUpdater.setFeedURL(`${getServerUrl()}`, {\"Cache-Control\": \"no-cache\"})\n\n            this.nativeUpdater.once(\"error\", reject)\n            this.nativeUpdater.checkForUpdates()\n          })\n        })\n      }\n    })\n  }\n\n  quitAndInstall(): void {\n    this.nativeUpdater.quitAndInstall()\n  }\n}"],"sourceRoot":""}
